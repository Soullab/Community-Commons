openapi: 3.0.3
info:
  title: Soullab Kernel API
  version: "1.0.0"
  description: |
    Consciousness-centric capabilities for developers.

    Privacy-first: Memory uses "sanctuary mode" by default.
    Data is NOT stored unless explicitly requested with mode: "save".

servers:
  - url: http://localhost:3000
    description: Local development

paths:
  /v1/health:
    get:
      summary: Kernel health check
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string, enum: [ok] }
                  version: { type: string }
                  behavior_versions:
                    type: array
                    items: { type: string }
                  capabilities:
                    type: array
                    items: { type: string }

  /v1/spiralogic/detect:
    post:
      summary: Detect consciousness facet from signals
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SpiralogicDetectRequest"
      responses:
        "200":
          description: Facet detected
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SpiralogicDetectResponse"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"

  /v1/ain/deliberate:
    post:
      summary: Multi-agent deliberation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AinDeliberateRequest"
      responses:
        "200":
          description: Deliberation complete
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AinDeliberateResponse"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"

  /v1/memory/write:
    post:
      summary: Write a memory item
      description: |
        Privacy-first: defaults to "sanctuary" mode where data is acknowledged
        but NOT stored. Only persists when mode = "save" is explicitly set.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MemoryWriteRequest"
      responses:
        "200":
          description: Sanctuary mode - acknowledged but NOT stored
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MemorySanctuaryResponse"
        "201":
          description: Stored (mode=save)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MemoryStoredResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"

  /v1/memory/retrieve:
    post:
      summary: Retrieve memories with filtering
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MemoryRetrieveRequest"
      responses:
        "200":
          description: Memories retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MemoryRetrieveResponse"

  /v1/memory/patterns/{user_id}:
    get:
      summary: Get memory patterns for a user
      parameters:
        - name: user_id
          in: path
          required: true
          schema: { type: string }
        - name: org_id
          in: query
          required: true
          schema: { type: string }
        - name: space_id
          in: query
          schema: { type: string }
      responses:
        "200":
          description: Patterns returned
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MemoryPatternsResponse"

  /v1/memory/health:
    get:
      summary: Memory store health check
      responses:
        "200":
          description: Memory store is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string, enum: [ok] }
                  service: { type: string, enum: [memory] }
                  store_type: { type: string }
                  total_items: { type: integer }

  /v1/practices/generate:
    post:
      summary: Generate consciousness practices for a facet
      description: |
        Returns 3 element-appropriate practices based on the user's current
        consciousness facet, available time, and difficulty preference.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PracticesGenerateRequest"
      responses:
        "200":
          description: Practices generated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PracticesGenerateResponse"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"

  /v1/practices/health:
    get:
      summary: Practices service health check
      responses:
        "200":
          description: Practices service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string, enum: [ok] }
                  service: { type: string, enum: [practices] }
                  capabilities:
                    type: array
                    items: { type: string }
                  behavior_version_default: { type: string }

components:
  schemas:
    TenantContext:
      type: object
      required: [org_id, space_id, user_id]
      properties:
        org_id: { type: string, minLength: 1 }
        space_id: { type: string, minLength: 1 }
        user_id: { type: string, minLength: 1 }

    FacetCode:
      type: string
      enum: [F1, F2, W1, W2, W3, E1, E2, E3, E4, A1, A2, A3, AETHER]

    ErrorEnvelope:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code: { type: string }
            message: { type: string }
            retry_after_ms: { type: integer }

    SpiralogicDetectRequest:
      type: object
      required: [org_id, user_id, signals]
      properties:
        org_id: { type: string }
        user_id: { type: string }
        signals:
          type: object
          properties:
            text: { type: string }
            recent_themes:
              type: array
              items: { type: string }
            biomarker_ref: { type: string }

    SpiralogicDetectResponse:
      type: object
      properties:
        facet_code: { $ref: "#/components/schemas/FacetCode" }
        confidence: { type: number }
        signals:
          type: array
          items:
            type: object
            properties:
              type: { type: string }
              value: { type: string }
              weight: { type: number }
        spiral_position:
          type: object
          properties:
            phase: { type: string }
            level: { type: integer }
            angular_position: { type: number }
            radial_distance: { type: number }
            elemental_blend:
              type: object
              additionalProperties: { type: number }
        behavior_version: { type: string }

    AinDeliberateRequest:
      allOf:
        - $ref: "#/components/schemas/TenantContext"
        - type: object
          required: [question]
          properties:
            question: { type: string, minLength: 1 }
            context:
              type: object
              properties:
                facet_code: { $ref: "#/components/schemas/FacetCode" }
                memory_refs:
                  type: array
                  items: { type: string }
                framings:
                  type: array
                  items: { type: string }
            agents:
              type: array
              items: { type: string }

    AinDeliberateResponse:
      type: object
      properties:
        id: { type: string }
        question: { type: string }
        agents:
          type: array
          items: { type: string }
        votes:
          type: array
          items:
            type: object
            properties:
              agent: { type: string }
              score: { type: number }
              recommendation: { type: string }
        synthesis: { type: string }
        emergence_score: { type: number }
        behavior_version: { type: string }

    MemoryWriteRequest:
      allOf:
        - $ref: "#/components/schemas/TenantContext"
        - type: object
          required: [kind]
          properties:
            kind:
              type: string
              enum: [journal, insight, session, transcript, practice, milestone]
            facet_code: { $ref: "#/components/schemas/FacetCode" }
            entities:
              type: array
              items: { type: string }
            tags:
              type: array
              items: { type: string }
            significance:
              type: number
              minimum: 0
              maximum: 1
            payload:
              type: object
              additionalProperties: true
            mode:
              type: string
              enum: [sanctuary, save]
              description: Privacy-first. Defaults to sanctuary (not stored) unless "save".

    MemorySanctuaryResponse:
      type: object
      required: [stored, reason]
      properties:
        stored:
          type: boolean
          enum: [false]
        reason:
          type: string
          enum: [SANCTUARY_MODE]
        behavior_version: { type: string }

    MemoryStoredResponse:
      type: object
      required: [id, stored, timestamp]
      properties:
        id: { type: string }
        stored:
          type: boolean
          enum: [true]
        org_id: { type: string }
        space_id: { type: string }
        user_id: { type: string }
        kind: { type: string }
        facet_code: { type: string }
        entities:
          type: array
          items: { type: string }
        tags:
          type: array
          items: { type: string }
        significance: { type: number }
        timestamp: { type: string, format: date-time }
        behavior_version: { type: string }

    MemoryRetrieveRequest:
      allOf:
        - $ref: "#/components/schemas/TenantContext"
        - type: object
          required: [query]
          properties:
            query:
              type: object
              properties:
                semantic: { type: string }
                facet_codes:
                  type: array
                  items: { $ref: "#/components/schemas/FacetCode" }
                entities:
                  type: array
                  items: { type: string }
                tags:
                  type: array
                  items: { type: string }
                kinds:
                  type: array
                  items: { type: string }
                time_range:
                  type: object
                  properties:
                    from: { type: string, format: date-time }
                    to: { type: string, format: date-time }
                min_significance: { type: number }
            limit:
              type: integer
              minimum: 1
              maximum: 100
              default: 20

    MemoryRetrieveResponse:
      type: object
      properties:
        items:
          type: array
          items:
            type: object
            properties:
              id: { type: string }
              kind: { type: string }
              facet_code: { type: string }
              entities:
                type: array
                items: { type: string }
              tags:
                type: array
                items: { type: string }
              significance: { type: number }
              timestamp: { type: string }
              content_preview: { type: string }
        summary:
          type: object
          properties:
            total_matches: { type: integer }
            returned: { type: integer }
            dominant_facet: { type: string }
        behavior_version: { type: string }

    MemoryPatternsResponse:
      type: object
      properties:
        user_id: { type: string }
        range:
          type: object
          properties:
            from: { type: string }
            to: { type: string }
        facet_frequency:
          type: object
          additionalProperties: { type: integer }
        top_entities:
          type: array
          items:
            type: object
            properties:
              entity: { type: string }
              count: { type: integer }
        top_tags:
          type: array
          items:
            type: object
            properties:
              tag: { type: string }
              count: { type: integer }
        transitions:
          type: array
          items:
            type: object
            properties:
              from: { type: string }
              to: { type: string }
              count: { type: integer }
        total_memories: { type: integer }
        behavior_version: { type: string }

    PracticesGenerateRequest:
      type: object
      required: [org_id, user_id, facet_code]
      properties:
        org_id: { type: string, minLength: 1 }
        user_id: { type: string, minLength: 1 }
        facet_code: { $ref: "#/components/schemas/FacetCode" }
        element_preference:
          type: string
          enum: [fire, water, earth, air, aether]
          description: Optional override. If omitted, derived from facet_code.
        duration_available_min:
          type: integer
          minimum: 5
          maximum: 120
          default: 15
        difficulty:
          type: string
          enum: [easy, moderate, advanced]
          default: easy
        contraindications:
          type: array
          items: { type: string }
          description: Tags of practices to exclude (e.g., ["physical", "breathwork"])

    PracticesGenerateResponse:
      type: object
      properties:
        practices:
          type: array
          items:
            $ref: "#/components/schemas/PracticeItem"
        behavior_version: { type: string }

    PracticeItem:
      type: object
      properties:
        id: { type: string }
        facet_code: { type: string }
        element:
          type: string
          enum: [fire, water, earth, air, aether]
        title: { type: string }
        duration_min: { type: integer }
        difficulty:
          type: string
          enum: [easy, moderate, advanced]
        steps:
          type: array
          items: { type: string }
        tags:
          type: array
          items: { type: string }
        contraindications:
          type: array
          items: { type: string }
